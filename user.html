<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ï‡¶≤ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏üí¶</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .main-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .contact-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .contact-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }
        
        .contact-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .contact-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .contact-status {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4cd964;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .contact-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .action-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
        }
        
        .chat-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .call-button {
            background: #ff2d55;
            color: white;
        }
        
        .action-button:hover {
            transform: scale(1.05);
        }
        
        .action-button svg {
            margin-right: 8px;
        }
        
        .ads-section {
            margin-top: 20px;
        }
        
        .ad-container {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .ad-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .ad-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .ad-content {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .ad-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 150px;
            object-fit: cover;
        }
        
        .chat-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            flex-direction: column;
            z-index: 100;
        }
        
        .chat-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .back-button {
            margin-right: 15px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.2);
            border-top-left-radius: 5px;
        }
        
        .sent {
            align-self: flex-end;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-top-right-radius: 5px;
        }
        
        .message-time {
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }
        
        .message-input-container {
            display: flex;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .message-input {
            flex: 1;
            padding: 12px 18px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
        }
        
        .message-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .send-button {
            background: #ff2d55;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-button:hover {
            transform: scale(1.1);
        }
        
        .video-call-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: none;
            flex-direction: column;
            z-index: 200;
        }
        
        .video-container {
            flex: 1;
            position: relative;
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 160px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .local-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .call-controls {
            padding: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .call-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .end-call {
            background: #ff3b30;
        }
        
        .mute-button, .camera-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .call-button:hover {
            transform: scale(1.1);
        }
        
        .demo-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }
        
        .warning-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            max-width: 80%;
            color: #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .warning-button {
            background: #ff2d55;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            margin-top: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .warning-button:hover {
            transform: scale(1.05);
        }
        
        .floating-action-button {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 70px;
            height: 70px;
            background: #ff2d55;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(255, 45, 85, 0.4);
            cursor: pointer;
            z-index: 50;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        .floating-action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 45, 85, 0.6);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .connecting-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
        }

        .connecting-dots {
            display: flex;
            margin: 20px 0;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff2d55;
            margin: 0 5px;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="header">
        ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ï‡¶≤ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏üí¶
    </div>
    
    <div class="main-container">
        <div class="contact-card">
            <div class="contact-header">
                <div class="contact-avatar">
                    <img src="https://i.postimg.cc/y65BrFLy/Picsart-25-11-05-05-34-56-682.jpg" alt="Service Girl" id="contact-avatar">
                </div>
                <div class="contact-info">
                    <div class="contact-name" id="contact-name">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶ó‡¶æ‡¶∞‡ßç‡¶≤ üí¶</div>
                    <div class="contact-status">
                        <div class="status-indicator"></div>
                        <span>Online - Tap to chat</span>
                    </div>
                </div>
            </div>
            <div class="contact-actions">
                <button class="action-button chat-button" id="chat-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/>
                    </svg>
                    Chat
                </button>
                <button class="action-button call-button" id="video-call-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 10.5V7C17 5.89543 16.1046 5 15 5H5C3.89543 5 3 5.89543 3 7V17C3 18.1046 3.89543 19 5 19H15C16.1046 19 17 18.1046 17 17V13.5L21 17.5V6.5L17 10.5Z" fill="white"/>
                    </svg>
                    Video Call
                </button>
            </div>
        </div>
        
        <div class="ads-section" id="ads-section">
            <div class="loading">Loading ads...</div>
        </div>
    </div>
    
    <div class="chat-container" id="chat-container">
        <div class="chat-header">
            <div class="back-button" id="back-button">‚Üê</div>
            <div class="contact-info">
                <div class="contact-name" id="chat-contact-name">‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶ó‡¶æ‡¶∞‡ßç‡¶≤ üí¶</div>
                <div class="contact-status">
                    <div class="status-indicator"></div>
                    <span>Online</span>
                </div>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <div class="loading">Loading messages...</div>
        </div>
        
        <div class="message-input-container">
            <input type="text" class="message-input" id="message-input" placeholder="Type a message...">
            <button class="send-button" id="send-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
    
    <div class="video-call-container" id="video-call-container">
        <div class="video-container" id="video-container">
            <!-- Dynamic content will be added here -->
        </div>
        
        <div class="call-controls">
            <button class="call-button mute-button" id="mute-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1C13.1 1 14 1.9 14 3V8C14 9.1 13.1 10 12 10C10.9 10 10 9.1 10 8V3C10 1.9 10.9 1 12 1Z" fill="white"/>
                    <path d="M16 10V8C16 5.8 14.2 4 12 4C9.8 4 8 5.8 8 8V10C6.9 10 6 10.9 6 12V16C6 17.1 6.9 18 8 18H16C17.1 18 18 17.1 18 16V12C18 10.9 17.1 10 16 10Z" fill="white"/>
                    <path d="M12 20C13.1 20 14 19.1 14 18H10C10 19.1 10.9 20 12 20Z" fill="white"/>
                </svg>
            </button>
            
            <button class="call-button end-call" id="end-call-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 5C3 3.89543 3.89543 3 5 3H8.27924C8.70967 3 9.09181 3.27543 9.22792 3.68377L10.7257 8.17721C10.8831 8.64932 10.6694 9.16531 10.2243 9.38787L7.96701 10.5165C9.06925 12.9612 11.0388 14.9308 13.4835 16.033L14.6121 13.7757C14.8347 13.3306 15.3507 13.1169 15.8228 13.2743L20.3162 14.7721C20.7246 14.9082 21 15.2903 21 15.7208V19C21 20.1046 20.1046 21 19 21H18C9.71573 21 3 14.2843 3 6V5Z" fill="white"/>
                </svg>
            </button>
            
            <button class="call-button camera-button" id="camera-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 3H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
    
    <div class="demo-warning" id="demo-warning">
        <div class="warning-content">
            <h3>‡¶°‡ßá‡¶Æ‡ßã ‡¶ï‡¶≤</h3>
            <p>‡¶°‡ßá‡¶Æ‡ßã ‡¶ï‡¶≤ ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø, ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ï‡¶≤ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶®‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶ó‡¶æ‡¶∞‡ßç‡¶≤‡¶ï‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡¶ø‡¶®</p>
            <button class="warning-button" id="warning-ok-button">OK</button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNSpf0ZyFMpX-J05g0E8t9wLod3rzdSJE",
            authDomain: "video-call-service-e072e.firebaseapp.com",
            projectId: "video-call-service-e072e",
            storageBucket: "video-call-service-e072e.firebasestorage.app",
            messagingSenderId: "880044601351",
            appId: "1:880044601351:web:4918aa95d2e5ef695f3aa2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // DOM elements
        const chatButton = document.getElementById('chat-button');
        const chatContainer = document.getElementById('chat-container');
        const backButton = document.getElementById('back-button');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const videoCallButton = document.getElementById('video-call-button');
        const videoCallContainer = document.getElementById('video-call-container');
        const videoContainer = document.getElementById('video-container');
        const endCallButton = document.getElementById('end-call-button');
        const muteButton = document.getElementById('mute-button');
        const cameraButton = document.getElementById('camera-button');
        const demoWarning = document.getElementById('demo-warning');
        const warningOkButton = document.getElementById('warning-ok-button');
        const adsSection = document.getElementById('ads-section');
        const contactAvatar = document.getElementById('contact-avatar');
        const contactName = document.getElementById('contact-name');
        const chatContactName = document.getElementById('chat-contact-name');
        
        // State variables
        let hasMadeVideoCall = false;
        let isMuted = false;
        let isCameraOff = false;
        let localStream = null;
        let currentUser = null;
        let unsubscribeMessages = null;
        let settings = {};
        
        // üî• ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì URL - ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶∞ direct MP4 URL ‡¶¶‡¶ø‡¶®
        let demoVideoUrl = "https://www.sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4";

        // Firebase Auth State Observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                console.log('User signed in:', user.uid);
                
                // Create or update user document
                db.collection('users').doc(user.uid).set({
                    name: 'User ' + Math.floor(Math.random() * 1000),
                    status: 'online',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    isBlocked: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                loadSettings();
                loadAds();
                
            } else {
                // Create anonymous user
                auth.signInAnonymously()
                    .then((userCredential) => {
                        currentUser = userCredential.user;
                        console.log('Anonymous user created:', currentUser.uid);
                    })
                    .catch((error) => {
                        console.error('Authentication error:', error);
                        alert('Authentication failed. Please refresh the page.');
                    });
            }
        });

        // Load settings from Firebase
        function loadSettings() {
            db.collection('settings').doc('appSettings')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        settings = doc.data();
                        console.log('Settings loaded:', settings);
                        
                        // Update UI with settings
                        if (settings.serviceName) {
                            contactName.textContent = settings.serviceName;
                            chatContactName.textContent = settings.serviceName;
                            document.title = settings.serviceName;
                        }
                        
                        if (settings.contactImage) {
                            contactAvatar.src = settings.contactImage;
                        }
                        
                        if (settings.demoVideo) {
                            demoVideoUrl = settings.demoVideo;
                        }
                        
                    } else {
                        console.log('No settings found, using defaults');
                    }
                }, (error) => {
                    console.error('Error loading settings:', error);
                });
        }

        // Load ads from Firebase
        function loadAds() {
            db.collection('ads')
                .where('isActive', '==', true)
                .orderBy('order', 'asc')
                .limit(5)
                .get()
                .then((querySnapshot) => {
                    adsSection.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        adsSection.innerHTML = '<div class="loading">No ads available</div>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const ad = doc.data();
                        const adDiv = document.createElement('div');
                        adDiv.classList.add('ad-container');
                        adDiv.innerHTML = `
                            <div class="ad-title">${ad.title}</div>
                            <div class="ad-content">${ad.content}</div>
                            ${ad.imageUrl ? `<img src="${ad.imageUrl}" class="ad-image" alt="${ad.title}">` : ''}
                        `;
                        adsSection.appendChild(adDiv);
                    });
                })
                .catch((error) => {
                    console.error('Error loading ads:', error);
                    adsSection.innerHTML = '<div class="loading">Error loading ads</div>';
                });
        }

        // Event listeners
        chatButton.addEventListener('click', openChat);
        backButton.addEventListener('click', closeChat);
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        videoCallButton.addEventListener('click', startVideoCall);
        endCallButton.addEventListener('click', endVideoCall);
        muteButton.addEventListener('click', toggleMute);
        cameraButton.addEventListener('click', toggleCamera);
        warningOkButton.addEventListener('click', function() {
            demoWarning.style.display = 'none';
        });

        // Functions
        function openChat() {
            chatContainer.style.display = 'flex';
            loadMessages();
        }

        function closeChat() {
            chatContainer.style.display = 'none';
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
        }

        function loadMessages() {
            if (!currentUser) return;
            
            chatMessages.innerHTML = '<div class="loading">Loading messages...</div>';
            
            // Clear existing listener
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            unsubscribeMessages = db.collection('messages')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'asc')
                .onSnapshot((querySnapshot) => {
                    chatMessages.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        // Add welcome message
                        addMessage('Hello! How can I help you today?', 'received');
                    } else {
                        querySnapshot.forEach((doc) => {
                            const message = doc.data();
                            addMessage(message.message, message.type, message.timestamp);
                        });
                        
                        // Mark messages as read
                        querySnapshot.forEach((doc) => {
                            if (!doc.data().isRead) {
                                db.collection('messages').doc(doc.id).update({
                                    isRead: true
                                });
                            }
                        });
                    }
                }, (error) => {
                    console.error('Error loading messages:', error);
                    chatMessages.innerHTML = '<div class="loading">Error loading messages</div>';
                });
        }

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText && currentUser) {
                // Add message to Firebase
                db.collection('messages').add({
                    userId: currentUser.uid,
                    userName: 'User',
                    message: messageText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isRead: false,
                    type: 'sent'
                }).then(() => {
                    messageInput.value = '';
                    
                    // Simulate admin reply after delay
                    setTimeout(() => {
                        db.collection('messages').add({
                            userId: currentUser.uid,
                            userName: 'Admin',
                            message: 'Thank you for your message. How can I help you?',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            isRead: false,
                            type: 'received'
                        });
                    }, 1000 + Math.random() * 2000);
                }).catch((error) => {
                    console.error('Error sending message:', error);
                    alert('Error sending message. Please try again.');
                });
            }
        }

        function addMessage(text, type, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            
            const time = timestamp ? 
                new Date(timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) :
                new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        let hasCallStarted = false;

        function startVideoCall() {
            if (hasMadeVideoCall) {
                demoWarning.style.display = 'flex';
                return;
            }
            
            hasMadeVideoCall = true;
            
            // Show connecting animation
            showVideoCallScreen();
            videoContainer.innerHTML = `
                <div class="connecting-animation">
                    <h2>Connecting...</h2>
                    <div class="connecting-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <p>Please wait while we connect your call</p>
                </div>
            `;
            
            // Get user's real camera
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                
                // Show video call interface with user's camera
                videoContainer.innerHTML = `
                    <video id="remote-video" class="remote-video" autoplay muted></video>
                    <div class="local-video">
                        <video id="local-video" autoplay muted></video>
                    </div>
                `;
                
                document.getElementById('local-video').srcObject = stream;
                
                // Send call request to Firebase
                if (currentUser) {
                    db.collection('calls').add({
                        userId: currentUser.uid,
                        userName: 'User',
                        status: 'requested',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        duration: 0
                    });
                }
                
                // Play demo video after 3 seconds (like real call connecting)
                setTimeout(() => {
                    const remoteVideo = document.getElementById('remote-video');
                    remoteVideo.src = demoVideoUrl;
                    remoteVideo.play();
                    
                    // üî• ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶ï‡¶≤ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ï‡ßá‡¶ü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá (‡¶∏‡¶æ‡¶á‡¶≤‡ßá‡¶®‡ßç‡¶ü)
                    remoteVideo.addEventListener('ended', function() {
                        endVideoCall(); // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ï‡¶≤ ‡¶ï‡ßá‡¶ü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá, ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
                    });
                    
                    hasCallStarted = true;
                    
                    // Update call status to accepted
                    if (currentUser) {
                        db.collection('calls')
                            .where('userId', '==', currentUser.uid)
                            .where('status', '==', 'requested')
                            .get()
                            .then((querySnapshot) => {
                                querySnapshot.forEach((doc) => {
                                    doc.ref.update({
                                        status: 'accepted'
                                    });
                                });
                            });
                    }
                }, 3000);
                
            }).catch(error => {
                console.error('Camera error:', error);
                // If camera fails, still show the demo video
                videoContainer.innerHTML = `
                    <video id="remote-video" class="remote-video" autoplay muted></video>
                `;
                
                setTimeout(() => {
                    const remoteVideo = document.getElementById('remote-video');
                    remoteVideo.src = demoVideoUrl;
                    remoteVideo.play();
                    
                    // üî• ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶ï‡¶≤ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ï‡ßá‡¶ü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá (‡¶∏‡¶æ‡¶á‡¶≤‡ßá‡¶®‡ßç‡¶ü)
                    remoteVideo.addEventListener('ended', function() {
                        endVideoCall(); // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ï‡¶≤ ‡¶ï‡ßá‡¶ü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá, ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶®‡¶æ
                    });
                    
                    hasCallStarted = true;
                }, 2000);
            });
        }

        function showVideoCallScreen() {
            videoCallContainer.style.display = 'flex';
        }

        function endVideoCall() {
            videoCallContainer.style.display = 'none';
            hasCallStarted = false;
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Update call status
            if (currentUser) {
                db.collection('calls')
                    .where('userId', '==', currentUser.uid)
                    .where('status', '==', 'accepted')
                    .get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            const callStartTime = doc.data().timestamp.toDate();
                            const duration = Math.floor((Date.now() - callStartTime) / 1000);
                            
                            doc.ref.update({
                                status: 'ended',
                                duration: duration
                            });
                        });
                    });
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = !isMuted;
                });
            }
            // Change button appearance
            muteButton.style.backgroundColor = isMuted ? '#ff3b30' : 'rgba(255, 255, 255, 0.2)';
        }

        function toggleCamera() {
            isCameraOff = !isCameraOff;
            if (localStream) {
                localStream.getVideoTracks().forEach(track => {
                    track.enabled = !isCameraOff;
                });
            }
            // Change button appearance
            cameraButton.style.backgroundColor = isCameraOff ? '#ff3b30' : 'rgba(255, 255, 255, 0.2)';
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && currentUser) {
                // User left the page, update status
                db.collection('users').doc(currentUser.uid).update({
                    status: 'offline',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else if (currentUser) {
                // User returned, update status
                db.collection('users').doc(currentUser.uid).update({
                    status: 'online'
                });
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                // Update user status to offline
                db.collection('users').doc(currentUser.uid).update({
                    status: 'offline',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });

        // Check if user is blocked
        if (currentUser) {
            db.collection('users').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        if (userData.isBlocked) {
                            alert('Your account has been blocked. Please contact support.');
                            // Disable features for blocked users
                            chatButton.disabled = true;
                            videoCallButton.disabled = true;
                        }
                    }
                });
        }
    </script>
</body>
</html>